<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rescatando a Ramona - Master Farmacología</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&family=Nunito:wght@400;600;700&display=swap');

        body {
            font-family: 'Nunito', sans-serif;
            transition: background-image 0.5s ease, background-color 0.5s ease;
        }

        h1, h2, h3 { font-family: 'Fredoka', sans-serif; }

        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        
        .card-container { transition: transform 0.6s; }
        .card-container.flipped { transform: rotateY(180deg); }

        /* Animaciones */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .bird-anim { animation: float 3s ease-in-out infinite; }
        
        /* UI Elements */
        .star-active {
            fill: #fbbf24 !important; color: #fbbf24 !important; stroke: #d97706 !important;
        }
        .floating-btn { z-index: 50; }
        .blur-category {
            filter: blur(4px); opacity: 0.5; user-select: none;
            background-color: #e5e7eb !important; color: transparent !important;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px);
        }
        .custom-bird-img {
            object-fit: cover; border-radius: 50%; border: 2px solid white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* Estilos para Accordion/Desplegables en cartas */
        details > summary {
            list-style: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary { margin-bottom: 0.5rem; }
        details > summary:hover { background-color: #f3f4f6; }
        
        /* Scrollbar personalizado para el reverso */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body class="bg-gradient-to-b from-blue-100 to-green-100 min-h-screen flex flex-col text-slate-800" id="main-body">

    <!-- APP CONTAINER -->
    <div id="app" class="flex-grow flex flex-col items-center justify-center p-4 w-full max-w-lg mx-auto relative">
        
        <!-- ==================== PANTALLA DE BIENVENIDA (SELECCIÓN DE MAZO) ==================== -->
        <div id="welcome-screen" class="text-center space-y-6 bg-white p-8 rounded-2xl shadow-xl w-full relative">
            <button onclick="toggleThemeModal()" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-purple-500 transition rounded-full hover:bg-purple-50">
                <i data-lucide="palette" class="w-6 h-6"></i>
            </button>

            <div id="welcome-bird-container" class="flex justify-center mb-4">
                <i data-lucide="bird" class="w-24 h-24 text-orange-500 bird-anim"></i>
            </div>
            
            <h1 class="text-3xl font-bold text-green-700">Rescatando a Ramona</h1>
            <p class="text-gray-600">¿Qué quieres estudiar hoy?</p>
            
            <div class="grid grid-cols-1 gap-4 mt-6">
                <!-- MAZO 1: ANTICUERPOS (OLD) -->
                <button onclick="selectDeckCategory('anticuerpos')" class="group bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 p-5 rounded-2xl transition transform hover:scale-105 text-left flex items-center gap-4 shadow-sm">
                    <div class="bg-blue-500 text-white p-3 rounded-full shadow-md">
                        <i data-lucide="dna" class="w-8 h-8"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-blue-900 text-xl">Anticuerpos</h3>
                        <p class="text-sm text-blue-700 opacity-80">Monoclonales y Terapias Dirigidas</p>
                    </div>
                </button>

                <!-- MAZO 2: ANTIINFECCIOSOS (NEW) -->
                <button onclick="selectDeckCategory('antiinfecciosos')" class="group bg-green-50 hover:bg-green-100 border-2 border-green-200 p-5 rounded-2xl transition transform hover:scale-105 text-left flex items-center gap-4 shadow-sm">
                    <div class="bg-green-500 text-white p-3 rounded-full shadow-md">
                        <i data-lucide="bug" class="w-8 h-8"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-green-900 text-xl">Antiinfecciosos</h3>
                        <p class="text-sm text-green-700 opacity-80">Antibióticos, Virus, Hongos...</p>
                    </div>
                </button>
            </div>
        </div>

        <!-- ==================== PANTALLA SELECCIÓN SUBGRUPO (ANTIINFECCIOSOS) ==================== -->
        <div id="subgroup-screen" class="hidden text-center space-y-4 bg-white p-6 rounded-2xl shadow-xl w-full relative">
            <button onclick="goBackToWelcome()" class="absolute top-4 left-4 p-2 text-gray-400 hover:text-blue-500">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            
            <h2 class="text-2xl font-bold text-green-800 pt-2">Antiinfecciosos</h2>
            <p class="text-sm text-gray-500">Elige un grupo o mézclalos todos</p>
            
            <div class="grid grid-cols-1 gap-3 max-h-[60vh] overflow-y-auto pr-1" id="subgroup-list">
                <!-- Se rellena dinámicamente con JS -->
            </div>
        </div>

        <!-- ==================== PANTALLA SELECCIÓN MODO JUEGO ==================== -->
        <div id="mode-screen" class="hidden text-center space-y-6 bg-white p-8 rounded-2xl shadow-xl w-full relative">
            <button onclick="goBackToSubgroupOrWelcome()" class="absolute top-4 left-4 p-2 text-gray-400 hover:text-blue-500">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>

            <h2 class="text-2xl font-bold text-gray-800" id="mode-title">Modo de Juego</h2>
            <p class="text-gray-500 text-sm" id="mode-subtitle">Selecciona cómo quieres avanzar</p>
            
            <div class="grid grid-cols-1 gap-4 mt-4">
                <button onclick="startMode('story')" class="group bg-orange-100 hover:bg-orange-200 border-2 border-orange-300 p-4 rounded-xl transition flex items-center gap-4">
                    <div class="bg-orange-500 text-white p-2 rounded-full"><i data-lucide="map" class="w-5 h-5"></i></div>
                    <div class="text-left">
                        <h3 class="font-bold text-orange-900">Modo Historia</h3>
                        <p class="text-xs text-orange-700">Niveles de 10 cartas.</p>
                    </div>
                </button>

                <button onclick="startMode('marathon')" class="group bg-blue-100 hover:bg-blue-200 border-2 border-blue-300 p-4 rounded-xl transition flex items-center gap-4">
                    <div class="bg-blue-500 text-white p-2 rounded-full"><i data-lucide="infinity" class="w-5 h-5"></i></div>
                    <div class="text-left">
                        <h3 class="font-bold text-blue-900">Modo Maratón</h3>
                        <p class="text-xs text-blue-700">Todo el mazo seguido.</p>
                    </div>
                </button>
            </div>
        </div>

        <!-- ==================== PANTALLA DE JUEGO ==================== -->
        <div id="game-screen" class="hidden w-full flex flex-col items-center relative pt-14">
            
            <button id="btn-home" onclick="goToMenu()" class="floating-btn absolute top-0 left-0 mt-2 ml-2 px-4 py-2 bg-white hover:bg-gray-50 rounded-full shadow-md text-blue-600 border border-blue-100 transition flex items-center gap-2 font-bold text-sm" title="Salir">
                <i data-lucide="home" class="w-4 h-4"></i> Inicio
            </button>

            <button id="btn-hint" onclick="toggleHintConfig()" class="floating-btn absolute top-0 right-0 mt-2 mr-2 px-4 py-2 bg-white hover:bg-yellow-50 rounded-full shadow-md text-gray-400 border border-gray-200 transition flex items-center gap-2 font-bold text-sm">
                <span class="text-xs">Pista</span> <i data-lucide="lightbulb" class="w-4 h-4"></i>
            </button>

            <!-- HUD -->
            <div class="w-full mb-4 mt-2">
                <div class="flex justify-between items-center mb-2 px-1">
                    <div class="flex flex-col items-start">
                        <span id="level-indicator" class="text-xs font-bold text-purple-600 uppercase tracking-wider bg-purple-100 px-2 py-0.5 rounded mb-1 w-fit">Nivel 1</span>
                        <h2 id="level-title" class="text-sm font-bold text-gray-700 truncate w-48 text-left">...</h2>
                    </div>
                    <div class="text-right">
                         <div class="text-xs text-gray-500 font-bold">PUNTOS</div>
                         <div class="text-xl font-bold text-green-600" id="score-display">0</div>
                    </div>
                </div>
                <div class="w-full h-3 bg-gray-200 rounded-full relative overflow-visible shadow-inner">
                    <div id="progress-bar" class="h-full bg-gradient-to-r from-orange-400 to-red-500 transition-all duration-500 rounded-full" style="width: 0%;"></div>
                    <div id="bird-icon-bar" class="absolute top-1/2 -translate-y-1/2 transition-all duration-500" style="left: 0%;">
                        <i data-lucide="bird" class="w-6 h-6 text-orange-600 -ml-3 bg-white rounded-full p-0.5 shadow-sm border border-orange-200"></i>
                    </div>
                </div>
            </div>

            <!-- FLASH CARD AREA -->
            <div class="perspective-1000 w-full h-96 cursor-pointer group mb-4 relative z-0" onclick="if(!isCardFlipped) flipCard()">
                <div id="flashcard" class="card-container relative w-full h-full text-center transition-all duration-500 transform-style-3d shadow-2xl rounded-2xl">
                    
                    <!-- FRONT -->
                    <div class="absolute w-full h-full backface-hidden bg-white rounded-2xl p-6 flex flex-col items-center justify-center border-2 border-blue-100">
                        <button onclick="toggleReview(event)" class="absolute top-3 left-3 p-3 rounded-full bg-gray-50 hover:bg-gray-100 transition z-20 focus:outline-none star-btn shadow-sm border border-gray-100">
                            <i data-lucide="star" class="w-6 h-6 text-gray-300 transition-colors"></i>
                        </button>
                        <span id="card-category" class="absolute top-4 right-4 text-xs font-bold text-blue-500 bg-blue-100 px-2 py-1 rounded-full uppercase tracking-wider transition-all duration-300">Categoría</span>
                        <div class="mb-4">
                            <i data-lucide="pill" class="w-12 h-12 text-blue-400 mx-auto mb-2"></i>
                            <h2 class="text-sm text-gray-400 font-semibold uppercase">Fármaco / Grupo</h2>
                        </div>
                        <h3 id="card-drug" class="text-2xl font-extrabold text-slate-800 break-words w-full px-2">Nombre</h3>
                        <p class="mt-8 text-sm text-gray-400 animate-pulse">(Toca para ver)</p>
                    </div>

                    <!-- BACK -->
                    <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-slate-50 rounded-2xl p-4 flex flex-col border-2 border-orange-100 overflow-hidden">
                         <div class="flex justify-between items-start mb-2 w-full">
                             <button onclick="toggleReview(event)" class="p-2 rounded-full bg-gray-50 hover:bg-gray-100 transition z-20 focus:outline-none star-btn shadow-sm border border-gray-100">
                                <i data-lucide="star" class="w-5 h-5 text-gray-300 transition-colors"></i>
                            </button>
                            <h3 id="back-card-title" class="text-sm font-bold text-gray-600 text-right w-3/4 truncate">Fármaco</h3>
                         </div>

                         <!-- Contenido Dinámico con Desplegables -->
                         <div id="card-details-content" class="text-left space-y-2 overflow-y-auto flex-grow pr-1 custom-scrollbar">
                            <!-- Se inyecta via JS -->
                         </div>
                    </div>
                </div>
            </div>

            <!-- CONTROLS -->
            <div id="controls" class="flex gap-4 w-full opacity-0 pointer-events-none transition-opacity duration-300">
                <button onclick="handleAnswer(false)" class="flex-1 bg-red-100 hover:bg-red-200 text-red-700 font-bold py-3 rounded-xl border border-red-300 transition flex flex-col items-center justify-center gap-1 shadow-sm">
                    <i data-lucide="x-circle" class="w-5 h-5"></i>
                    <span>Fallé</span>
                </button>
                <button onclick="handleAnswer(true)" class="flex-1 bg-green-100 hover:bg-green-200 text-green-700 font-bold py-3 rounded-xl border border-green-300 transition flex flex-col items-center justify-center gap-1 shadow-sm">
                    <i data-lucide="check-circle" class="w-5 h-5"></i>
                    <span>¡Lo sabía!</span>
                    <span class="text-[10px] font-normal opacity-75">Avanzar</span>
                </button>
            </div>
        </div>

        <!-- PANTALLAS FINALES -->
        <div id="level-complete-screen" class="hidden text-center space-y-6 bg-white p-8 rounded-2xl shadow-xl w-full">
            <i data-lucide="trophy" class="w-20 h-20 text-yellow-400 animate-bounce mx-auto"></i>
            <h2 class="text-2xl font-bold text-green-700">¡Nivel Completado!</h2>
            <button onclick="nextLevel()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl">Siguiente</button>
        </div>

        <div id="end-screen" class="hidden text-center space-y-6 bg-white p-8 rounded-2xl shadow-xl w-full relative">
            <div id="end-bird-container" class="flex justify-center mb-4 relative"></div>
            <h1 class="text-3xl font-bold text-green-700">¡Ramona Rescatada!</h1>
            <div class="grid grid-cols-2 gap-4 mt-4">
                <div class="bg-gray-100 p-3 rounded-lg"><p class="text-xs">Puntos</p><p class="text-xl font-bold text-green-600" id="final-score">0</p></div>
                <div class="bg-gray-100 p-3 rounded-lg"><p class="text-xs">Errores</p><p class="text-xl font-bold text-red-500" id="final-errors">0</p></div>
            </div>
            <button onclick="goToMenu()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-xl">Volver al Inicio</button>
        </div>
    </div>

    <!-- MODAL PERSONALIZAR -->
    <div id="theme-modal" class="hidden fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-700">Personalizar</h3>
                <button onclick="toggleThemeModal()"><i data-lucide="x" class="w-5 h-5 text-gray-400"></i></button>
            </div>
            <div class="mb-4">
                <h4 class="text-xs font-bold text-gray-500 mb-2">AVATAR</h4>
                <label class="cursor-pointer bg-gray-50 text-gray-600 hover:bg-gray-100 py-2 px-4 rounded-lg flex items-center gap-2 text-sm border border-gray-200">
                    <i data-lucide="upload" class="w-4 h-4"></i> Subir foto
                    <input type="file" class="hidden" accept="image/*" onchange="handleImageUpload(event)">
                </label>
            </div>
            <div class="grid grid-cols-1 gap-2">
                <h4 class="text-xs font-bold text-gray-500">TEMA</h4>
                <button onclick="setTheme('default')" class="w-full text-left p-2 rounded hover:bg-blue-50 text-sm">Original</button>
                <button onclick="setTheme('sunset')" class="w-full text-left p-2 rounded hover:bg-orange-50 text-sm">Atardecer</button>
                <button onclick="setTheme('mint')" class="w-full text-left p-2 rounded hover:bg-teal-50 text-sm">Menta</button>
            </div>
        </div>
    </div>

    <script>
        // --- BASE DE DATOS MASIVA (CSV RAW INTEGRADO) ---
        const CSV_ANTIBACTERIANOS = `Fármaco / Grupo,Mecanismo de Acción,Resistencia,Farmacocinética,Reacciones Adversas,Espectro e Indicaciones,Observaciones
"AMINOGLUCÓSIDOS(Amikacina, Gentamicina, Tobramicina, Estreptomicina, Neomicina, Paromomicina)",Inhiben síntesis proteica (sub 30s),"- Modificación enzimática - Disminución entrada AB - Resistencia adaptativa","- IV e IM (Tópica: neo; Oral: paro) - Hidrosolubles, elimin. renal - Se inactivan pH ácido","- Nefrotoxicidad (Monitorizar) - Ototoxicidad - Neurotoxicidad","- Bacilos G(-) aerobios (P. aeruginosa) - TBC (Estrepto/Amika) - Amebas/Cestodos (Paro)","- Conc. dependiente, EPA prolongado - Sinergia con B-lactámicos - Esterilización TGI (Neo)"
"B-LACTÁMICOS(Penicilinas, Cefalosporinas, Carbapenemes, Monobactamas)",Inhiben síntesis de PG (inhiben PBPs),"- B-lactamasas (BLEE) - Modif. cromosómica PBPs - Bombas expulsión","- IV y Oral - Elim. renal (Excp. Ceftriaxona/Cefoxitina: biliar)","- Alteraciones TGI - Hipersensibilidad - Convulsiones (Imipenem) - Hemorragias (Cefalosporinas con metil-tio-tetrazol)","- Amplio espectro - Carbapenemes: SAMS, Listeria, Meningitis, Bacillus","- Elección embarazadas - Interacción Meropenem-Valproico - Ertapenem: NO P. aeruginosa"
"FENICOLES(Cloranfenicol)",Inhiben síntesis proteica (50s),Modif. enzimática (acetiltransferasas),"- Oral/IV, Met. hepático","- Aplasia medular - Síndrome niño gris","- Amplio espectro (tópico ocular)","- Inhibidor CYP3A4 - NO embarazo"
"TETRACICLINAS(Tetra, Doxi, Mino, Tigeciclina)",Inhiben síntesis proteica (30s),Bombas de expulsión,"- Oral (Doxi/Mino) - IV (Tige)","- Hueso/Dientes - Fotosensibilidad - Hepatotoxicidad (embarazo)","- Cólera, Peste, Brucella, Clamidia, Rickettsias - Tigeciclina: MR","- NO con lácteos/antiácidos - NO niños/embarazo"
"MACRÓLIDOS(Eritro, Claritro, Azitro)",Inhiben síntesis proteica (50s),Modif. diana (Metilación ARNr),"- Hepático (excp. Azitro) - Alto Vd (Azitro)","- Colestasis, QT, Ototoxicidad - Procinético (Eritro)","- Neumonía atípica (Legionella, Mycoplasma) - Alérgicos penicilina","- Inhibidores P-450 (Eritro) - Azitro: 3 días tto"
"SULFAMIDAS",Inhiben síntesis ác. fólico (Dihidropteroato),Hiperproducción PABA,"- Vd alto (LCR), Hepático/Renal","- Fotosensibilidad, Cristaluria - Kernicterus","- Nocardia, Pneumocystis (VIH) - Toxoplasma",- Sinergia con Trimetroprim (Cotrimoxazol)
"QUINOLONAS(Cipro, Levo, Moxi)",Inhiben ADN-girasa / Topoisomerasa IV,Mutaciones diana / Bombas,"- Oral/IV (Alta BD) - Quelación cationes","- Tendinitis/Rotura - QT, Glucemia, SNC","- ITU, Prostatitis, GEA - Respiratorio (Levo/Moxi)","- NO embarazo/niños - Moxi: No ITU (Hepatobiliar)"
"GLUCOPÉPTIDOS(Vancomicina, Teicoplanina)",Inhiben pared (D-Ala-D-Ala),Modif. diana (D-Ala-D-Lac),"- IV (Oral: C. diff) - Renal","- Hombre rojo (Vanco) - Nefro/Oto tox","- Gram (+) MRSA - C. difficile (Oral)","- Monitorizar niveles - Teico: IM posible"
"LIPOPEPTIDOS(Daptomicina)",Despolarización membrana (Salida K+),,"- IV, Renal","- Miopatía (CPK)","- Gram (+) MRSA, Endocarditis","- NO Neumonía (Surfactante)"
"OXAZOLIDINONAS(Linezolid, Tedizolid)",Inhiben síntesis proteica (50s),,"- Oral/IV (100% BD)","- Mielotoxicidad - Neuropatía, Serotoninérgico","- Gram (+) MRSA, ERV - Neumonía, Piel",- IMAO débil
"LINCOSAMIDAS(Clindamicina)",Inhiben síntesis proteica (50s),Metilación,"- Oral/IV, Biliar (Hueso)","- Diarrea (C. diff)","- Anaerobios (B. fragilis) - Gram (+) Alérgicos","- Osteomielitis - Abscesos"
"NITROIMIDAZOLES(Metronidazol)",Daño ADN (Radicales libres),,"- Oral/IV, Hepático","- Sabor metálico - Efecto Disulfiram - Neuropatía","- Anaerobios estrictos - Protozoos (Giardia, Ameba)","- C. difficile (Leve)"`;

        const CSV_ANTIFUNGICOS = `Grupo / Fármaco,Mecanismo,Farmacocinética,RAMs,Espectro e Indicaciones
"AZOLES(Fluconazol, Itraconazol, Voriconazol, Posaconazol)",Inhiben síntesis ergosterol (14-alfa-desmetilasa),"- Oral/IV - Inh. Cit P-450","- Hepatotoxicidad - Fotofobia (Vori) - QT","- Candida (Fluco) - Aspergillus (Vori/Posa) - Mucorales (Posa/Isavu)"
"POLIENOS(Anfotericina B)",Se une al ergosterol (poros membrana),"- IV (Liposomal < tóxica)","- Nefrotoxicidad - Reacción infusoria","- Micosis sistémicas graves - Leishmania"
"POLIENOS TÓPICOS(Nistatina)",Igual Anfotericina,"- Tópica / Oral (no abs)","- Nulas","- Candidiasis mucocutánea"
"EQUINOCANDINAS(Caspofungina, Micafungina)",Inhiben síntesis pared (B-glucano),- IV,"- Bien toleradas","- Candidiasis invasora - Aspergilosis (rescate)"
"ALILAMINAS(Terbinafina)",Inhiben escualeno-epoxidasa,"- Oral (lipofílico)","- GI, Gusto","- Dermatofitos (Tiñas, Uñas)"
"FLUCITOSINA",Antimetabolito (5-FU),"- IV / Oral (SNC)","- Mielotoxicidad","- Criptococosis (con Anfo B)"`;

        const CSV_ANTIPARASITARIOS = `Parasitosis,Fármaco,Mecanismo / Nota,Reacciones Adversas,Observaciones
"Amebas / Giardia","Metronidazol","Anaerobios","Efecto Disulfiram","Elección."
"","Paromomicina","Aminoglucósido oral","Poca abs.","Embarazo / Portador asintomático."
"Leishmaniosis","Antimoniales","IV / Infiltración","Cardio/Pancreatitis","1ª línea. Alt: Anfo B."
"Malaria","Cloroquina","Esquizonticida sanguíneo","Retinopatía","Zonas sensibles. Embarazo OK."
"","Primaquina","Esquizonticida tisular","Hemólisis (G6PD)","Elimina hipnozoítos (P. vivax)."
"","Artemisinas","","","Paludismo grave."
"Toxoplasmosis","Pirimetamina + Sulfadiazina","Inh. fólico","Mielotoxicidad","Añadir ác. folínico."
"Cestodos (Tenias)","Praziquantel","Parálisis (Ca2+)","","Elección."
"Nematodos","Albendazol / Mebendazol","Túbulos","GI, Hepatotox","Elección intestinales/quistes."
"","Ivermectina","Parálisis Cl-","Reacción Mazzotti","Strongyloides, Sarna, Oncocercosis."
"Ectoparásitos","Permetrina","Parálisis Na+","Poca tox.","Sarna, Piojos. Repetir 1 sem."
"","Lindano","Organoclorado","Neurotóxico","2ª línea (No embarazo/niños)."`;

        const CSV_ANTISEPTICOS = `Compuesto,Actividad,Mecanismo,Usos Principales,Notas
"Alcoholes (70%)","Bactericida, Virucida (No esporas)","Desnaturaliza proteínas","Piel sana, manos","No en heridas abiertas."
"Clorhexidina","Bacteriostático/cida","Membrana celular","Piel, heridas, lavado qx","Efecto residual. No tóxico."
"Povidona Yodada","Amplio (Esporicida lento)","Oxidación","Piel, heridas","Inactiva por materia orgánica. No embarazadas/neonatos."
"Agua Oxigenada","Bactericida débil","Radicales libres","Desbridamiento","Hemostático débil."
"Sulfadiazina Argéntica","Bactericida (incl. Pseudomonas)","Metales (Plata)","Quemaduras","Riesgo argiria."
"Glutaraldehído","Esterilizante","Alquilación","Instrumental","Tóxico (vapores)."`;

        const CSV_ANTITUBERCULOSOS = `Fármaco,Mecanismo de Acción,Resistencia,Farmacocinética,Reacciones Adversas,Espectro e Indicaciones,Observaciones
"ISONIAZIDA (H)",Inhibe síntesis ác. micólicos,Mutaciones enzima activación,"- Oral (ayunas) - Met. hepático (acetilación)","- Hepatotoxicidad - Neuropatía (déficit B6)","- M. tuberculosis - Profilaxis (monoterapia)","- 1ª línea - Suplem. Vit B6"
"RIFAMPICINA (R)",Inhibe ARN-polimerasa,Mutaciones enzima,"- Oral (ayunas) - Circ. enterohepática","- Tinte fluidos (naranja) - Hepatotoxicidad","- M. tb, Brucella, Legionella - Profilaxis Meningo/Haemophilus","- Potente inductor P-450 - Formas latentes"
"PIRAZINAMIDA (Z)",Inhibe síntesis ác. micólicos,,"- Oral (ayunas), Hepático","- Hepatotoxicidad - Hiperuricemia","- M. tb (No M. bovis) - Formas latentes","- NO embarazo - Acorta tto a 6 meses"
"ETAMBUTOL (E)",Inhibe pared celular,,"- Oral, Elim. renal","- Neuritis óptica (Monitorizar)","- M. tb y atípicas","- Contraindicado en niños"
"DAPSONA",Inhibe síntesis fólico,,- Hepático,"- Hemólisis, Metahemoglobinemia - Síndrome Dapsona","- M. leprae","- Reacción tipo I y II"
"CLOFAZIMINA",Inhibe ADN,,"- Vm muy larga (70 días)","- Coloración piel (rojiza)","- M. leprae",`;

        const CSV_ANTIVIRALES = `Grupo / Fármaco,Mecanismo,Farmacocinética,Reacciones Adversas,Indicaciones,Notas
"ANÁLOGOS NUCLEÓSIDOS(Aciclovir, Ganciclovir, Valaciclovir)",Inhiben ADN-pol (Requieren fosforilación),"- Renal (Ajuste IR) - Oral/IV","- Neurotoxicidad - Nefrotoxicidad (Cristales) - Mielotoxicidad (Ganciclovir)","- VHS, VVZ - CMV (Ganciclovir)","- Valaciclovir/Famciclovir: > BD oral"
"ANÁLOGOS NUCLEÓTIDOS(Cidofovir)",Inhibe ADN-pol (No requiere fosforilación),"- IV, Vm larga","- Nefrotoxicidad grave","- CMV (Retinitis), Adenovirus","- Adm. con Probenecid"
"FOSCARNET",Inhibe ADN-pol (Pirofosfato),- IV,"- Nefrotoxicidad, Hipocalcemia","- CMV, VHS resistentes","- Alternativa"
"ANTIGRIPALES(Oseltamivir, Zanamivir)",Inhiben Neuraminidasa,"- Oral (Osel), Inhalado (Zana)","- Pocos efectos graves","- Influenza A y B (<48h)",
"INTERFERONES",Inmunomodulador / Antiviral,"- SC / IM","- Síndrome pseudogripal - Depresión, Mielotoxicidad","- VHB, VHC, EM","- Pegilados > Vm"
"AAD VHC(Sofosbuvir, -previr, -asvir)","Inhiben NS3/4A, NS5A, NS5B",- Oral,- Bien tolerados,"- VHC (Pangenotípicos)","- Curación >95%"
"VIH: ITIAN(Zidovudina, Lamivudina, Tenofovir, Abacavir)",Inhiben Transcriptasa Inversa (Terminadores),"- Renal (Tenofovir) - Abacavir: HLA-B5701","- Mielotoxicidad (AZT) - Nefro/Osteo (TDF) - Hipersensibilidad (ABC)","- VIH 1 y 2, VHB (Tenofovir)","- TAF < toxicidad que TDF - AZT: parto"
"VIH: ITINAN(Efavirenz)",Inhiben TI (Cambio conformacional),- Hepático,"- SNC (Sueños vívidos) - Rash","- VIH 1 (No 2)",- Teratógeno
"VIH: IP(Darunavir, Ritonavir)",Inhiben Proteasa (Maduración),"- Hepático (Inh. potentes P-450)","- Metabólicos (Lípidos, Glucemia) - Lipodistrofia",- VIH,"- Ritonavir: Booster (Dosis baja)"
"VIH: INI(Dolutegravir, Bictegravir)",Inhiben Integrasa,,- Pocos (Insomnio, Cefalea),"- VIH (Alta barrera genética)",- Elección actual`;

        // Datos Clásicos (Anticuerpos y Otros)
        const OLD_DATA_RAW = [
            { cat: "ANTIVIRALES", drug: "ERTAPENEM", ind: "Tratamiento de infecciones en pacientes mayores de 3 años", mech: "Inhibe la síntesis de la pared celular bacteriana tras su unión a las proteínas fijadoras de penicilina (PBPs)" },
            { cat: "ANTIVIRALES", drug: "MARIBAVIR", ind: "Tratamiento de infecciones causadas por CMV en pacientes adultos trasplante células madre/órganos", mech: "Bloquea proteína cinasa UL97 del CMV" },
            { cat: "CÁNCER", drug: "ABEMACICLIB", ind: "Cáncer de mama HER2 negativo HR positivos", mech: "Inhibición potente y selectivo de las ciclinas CDK4/CK6" },
            { cat: "CÁNCER", drug: "ALECTINIB", ind: "Cáncer de pulmón no microcítico (CPNM) positivo para ALK", mech: "Inhibidor de la proteína quinasa que inhibe la autofosforilación de ALK y la fosforilación de la vía de señalización mediada por ALK" },
            { cat: "CÁNCER", drug: "AMIVANTAMAB", ind: "Cáncer de pulmón no microcítico (CPNM) con mutaciones activadoras de inserción en EGFR", mech: "Ac biespecífico dirigido frente a EGFR y MET" },
            { cat: "CÁNCER", drug: "APALUTAMIDA", ind: "Cáncer de próstata", mech: "Inhibidor del receptor androgénico impidiendo la síntesis de andrógenos" },
            { cat: "CÁNCER", drug: "ASCIMINIB", ind: "LMC", mech: "Inhibidor de la tirosina cinasa (TKI)" },
            { cat: "CÁNCER", drug: "ATEZOLIZUMAB", ind: "Carcinoma urotelial, cáncer de pulmón no de células pequeñas", mech: "Ac monoclonal que bloquea la unión PD-L1 con PD-1" },
            { cat: "CÁNCER", drug: "AVAPRITINIB", ind: "Tumor del estroma gastrointestinal metastásico no resecable (GIST)", mech: "Bloquea actividad de receptores PDGFRA" },
            { cat: "CÁNCER", drug: "AVELUMAB", ind: "Carcinoma de células de Merkel (CCM) metastásico", mech: "Ac monoclonal IgG1 dirigido contra PD-L1" },
            { cat: "CÁNCER", drug: "AXICABTAGENE CILOLEUCEL", ind: "Linfoma difuso de célula grande B refractario", mech: "Células T con receptor antigénico quimérico (CAR) anti CD19" },
            { cat: "CÁNCER", drug: "BELANTAMAB MAFODOTINA", ind: "Mieloma múltiple refractario", mech: "Ac monoclonal humanizado IgG1k específico para BCMA" },
            { cat: "CÁNCER", drug: "BINIMETINIB", ind: "Melanoma metastásico con mutacion BRAF V600", mech: "Inhibición de la kinasa MEK" },
            { cat: "CÁNCER", drug: "BLINATUMOMAB", ind: "LLA de precursores B con cromosoma Filadelfia negativo", mech: "Ac dirigido hacia los CD19 y CD3 de las células T" },
            { cat: "CÁNCER", drug: "BRENTUXIMAB VEDOTIN", ind: "Linfoma de Hodgkin", mech: "Ac conjugado anti CD30 que libera antineoplásico" },
            { cat: "CÁNCER", drug: "BRIGATINIB", ind: "Cáncer de pulmón no microcítico con mutacion ALK", mech: "Inhibición de la tirosin kinasa ALK y ROS1" },
            { cat: "CÁNCER", drug: "CAPIVASERTIB", ind: "Cáncer de mama", mech: "Inhibidor potente y selectivo de las 3 isoformas de quinasa AKT" },
            { cat: "CÁNCER", drug: "CAPMATINIB", ind: "Cáncer de pulmón no microcítico (CPNM)", mech: "Inhibidor del receptor tirosina quinasa MET" },
            { cat: "CÁNCER", drug: "CARFILZOMIB", ind: "Mieloma múltiple", mech: "Inhibidor irreversible del proteosoma" },
            { cat: "CÁNCER", drug: "CEMIPLIMAB", ind: "Cáncer de cérvix, carcinoma cutáneo de células escamosas", mech: "Ac monoclonal anti PD-1" },
            { cat: "CÁNCER", drug: "CERITINIB", ind: "CPNM positivo para ALK", mech: "Inhibidor de la proteína quinasa ALK" },
            { cat: "CÁNCER", drug: "CILTACABTAGENE AUTOLEUCEL", ind: "Mieloma múltiple", mech: "CAR-T dirigido contra BCMA" },
            { cat: "CÁNCER", drug: "COBIMETINIB", ind: "Melanoma con mutación BRAF V600", mech: "Bloquea la vía MAPK (MEK1 y MEK2)" },
            { cat: "CÁNCER", drug: "DACOMITINIB", ind: "Cáncer de pulmón no microcítico con mutación en EGFR", mech: "Inhibidor de la tirosinkinasa del EGFR" },
            { cat: "CÁNCER", drug: "DALBAVANCINA", ind: "LLC", mech: "Inhibidor de la tirosina cinasa de Bruton (BTK)" },
            { cat: "CÁNCER", drug: "DARATUMUMAB", ind: "Mieloma múltiple", mech: "Ac monoclonal IgG1 anti CD38" },
            { cat: "CÁNCER", drug: "DAROLUTAMIDA", ind: "Cáncer de próstata", mech: "Inhibidor del receptor androgénico (RA)" },
            { cat: "CÁNCER", drug: "DINUTUXIMAB", ind: "Neuroblastoma", mech: "Ac monoclonal anti gangliósido GD2" },
            { cat: "CÁNCER", drug: "DOSTARLIMAB", ind: "Cáncer de endometrio (dMMR/MSI-H)", mech: "Ac monoclonal IgG4 anti PD-1" },
            { cat: "CÁNCER", drug: "DURVALUMAB", ind: "Cáncer de pulmón no microcítico, carcinoma vías biliares", mech: "Ac monoclonal IgG1 anti PD-L1" },
            { cat: "CÁNCER", drug: "ELACESTRANT", ind: "Cáncer de mama RE+, HER2- con mutación ESR1", mech: "Antagonista y degradador del receptor-a de estrógeno (ERa)" },
            { cat: "CÁNCER", drug: "ELOTUZUMAB", ind: "Mieloma múltiple", mech: "Ac monoclonal IgG1 contra SLAMF7 (CS1)" },
            { cat: "CÁNCER", drug: "ENCORAFENIB", ind: "Melanoma metastásico con mutacion BRAF V600", mech: "Inhibición de la kinasa BRAF" },
            { cat: "CÁNCER", drug: "ENFORTUMAB VEDOTIN", ind: "Cáncer de vejiga", mech: "Ac monoclonal anti-Nectina-4 conjugado con MMAE" },
            { cat: "CÁNCER", drug: "ENTRECTINIB", ind: "Tumores sólidos con fusión NTRK, CPNM ROS1+", mech: "Inhibidor de TRKA, TRKB, TRKC, ROS1 y ALK" },
            { cat: "CÁNCER", drug: "EPCORITAMAB", ind: "Linfoma B difuso de células grandes", mech: "Ac biespecífico anti CD20 y CD3" },
            { cat: "CÁNCER", drug: "FLUCICLOVINA (18F)", ind: "Uso diagnóstico PET cáncer próstata", mech: "Aminoácido sintético transportado a células con expresión incrementada en cáncer" },
            { cat: "CÁNCER", drug: "FRUQUINTINIB", ind: "Cáncer colorrectal metastásico", mech: "Inhibidor selectivo de VEGFR-1, 2 y 3" },
            { cat: "CÁNCER", drug: "FUTIBATINIB", ind: "Colangiocarcinoma con fusión FGFR2", mech: "Inhibidor irreversible de FGFR 1-4" },
            { cat: "CÁNCER", drug: "GLASDEGIB", ind: "LMA", mech: "Inhibidor de la vía Hedgehog (Hh)" },
            { cat: "CÁNCER", drug: "GLOFITAMAB", ind: "Linfoma B difuso de células grandes", mech: "Ac biespecífico anti CD20 y CD3" },
            { cat: "CÁNCER", drug: "GLUCARPIDASA", ind: "Toxicidad por metotrexato", mech: "Enzima que hidroliza metotrexato" },
            { cat: "CÁNCER", drug: "GOZETOTIDE", ind: "Cáncer de próstata (Imagen)", mech: "Galio-68 se une a células que sobreexpresan PSMA" },
            { cat: "CÁNCER", drug: "IDECABTAGÉN VICLEUCEL", ind: "Mieloma múltiple", mech: "CAR-T dirigido a BCMA" },
            { cat: "CÁNCER", drug: "INOTUZUMAB OZOGAMICINA", ind: "LLA de precursores de células B CD22+", mech: "Ac monoclonal IgG4 anti CD22" },
            { cat: "CÁNCER", drug: "IPILIMUMAB", ind: "Melanoma, carcinoma de células renales", mech: "Inhibidor de CTLA-4" },
            { cat: "CÁNCER", drug: "ISATUXIMAB", ind: "Mieloma múltiple", mech: "Ac monoclonal anti CD38" },
            { cat: "CÁNCER", drug: "IVOSIDENIB", ind: "LMA, colangiocarcinoma", mech: "Inhibidor de isocitrato deshidrogenasa mutada (IDH1)" },
            { cat: "CÁNCER", drug: "IXAZOMIB", ind: "Mieloma múltiple", mech: "Inhibidor reversible del proteasoma" },
            { cat: "CÁNCER", drug: "LAROTRECTINIB", ind: "Tumores sólidos con mutaciones en NTRK", mech: "Inhibición receptores TRK" },
            { cat: "CÁNCER", drug: "LAZERTINIB", ind: "Cáncer de pulmón no microcítico", mech: "Inhibidor irreversible TKI del EGFR" },
            { cat: "CÁNCER", drug: "LENVATINIB", ind: "Carcinoma de tiroides", mech: "Inhibe actividad quinasa de VEGF" },
            { cat: "CÁNCER", drug: "LISOCABTAGENE MARALEUCEL", ind: "Tratamiento de linfoma", mech: "CAR-T dirigida a CD19" },
            { cat: "CÁNCER", drug: "LORLATINIB", ind: "CPNM avanzado con mutación ALK", mech: "Inhibición de ALK y ROS1" },
            { cat: "CÁNCER", drug: "LUTECIO (177Lu) OXODOTREOTIDO", ind: "Tumores neuroendocrinos gastroenteropancreáticos", mech: "Péptido radiactivo afín a receptores somatostatina" },
            { cat: "CÁNCER", drug: "MIDOSTAURINA", ind: "Mastocitosis", mech: "Inhibe múltiples receptores tirosina quinasa (FTL3, KIT)" },
            { cat: "CÁNCER", drug: "MIRVETUXIMAB SORAVTANSINE", ind: "Cáncer de ovario avanzado", mech: "Unión a FR-a e internalización del fármaco" },
            { cat: "CÁNCER", drug: "MOGAMULIZUMAB", ind: "Micosis fungoide o síndrome de Sézary", mech: "Ac anti-CCR4" },
            { cat: "CÁNCER", drug: "MOSUNETUZUMAB", ind: "Linfoma folicular", mech: "Ac biespecífico anti-CD20/CD3" },
            { cat: "CÁNCER", drug: "NECITUMUMAB", ind: "CPNM escamoso, EGFR positivo", mech: "Ac monoclonal IgG1 anti EGFR" },
            { cat: "CÁNCER", drug: "NERATINIB", ind: "Cáncer de mama HER2+ adyuvante", mech: "Inhibidor de tirosin kinasa EGFR, HER2, HER4" },
            { cat: "CÁNCER", drug: "NIRAPARIB", ind: "Cáncer ovario/trompas/peritoneo", mech: "Inhibidor de PARP-1 y PARP-2" },
            { cat: "CÁNCER", drug: "NIVOLUMAB", ind: "CPNM escamoso y melanoma avanzado", mech: "Ac monoclonal anti PD-1" },
            { cat: "CÁNCER", drug: "OLAPARIB", ind: "Cáncer prostático (sin quimio)", mech: "Inhibidor de PARP-1, 2 y 3" },
            { cat: "CÁNCER", drug: "OLARATUMAB", ind: "Sarcoma de tejidos blandos avanzado", mech: "Ac monoclonal antagonista de PDGFR-alfa" },
            { cat: "CÁNCER", drug: "OSIMERTINIB", ind: "CPNM con mutación T790M de EGFR", mech: "Inhibidor irreversible EGFRm y T790M" },
            { cat: "CÁNCER", drug: "PADELIPORFINA", ind: "Adenocarcinoma de próstata unilateral", mech: "Activación láser causa necrosis localizada" },
            { cat: "CÁNCER", drug: "PALBOCICLIB", ind: "Cáncer de mama RH+ HER2-", mech: "Inhibidor de CDK4 y CDK6" },
            { cat: "CÁNCER", drug: "PANOBINOSTAT", ind: "Mieloma múltiple", mech: "Inhibidor de histona deacetilasa" },
            { cat: "CÁNCER", drug: "PEMBROLIZUMAB", ind: "Melanoma avanzado y cáncer de mama", mech: "Ac monoclonal anti PD-1" },
            { cat: "CÁNCER", drug: "PEMIGATINIB", ind: "Colangiocarcinoma con fusión FGFR2", mech: "Inhibidor quinasa FGFR1, 2 y 3" },
            { cat: "CÁNCER", drug: "PERTUZUMAB/ TRASTUZUMAB", ind: "Cáncer de mama HER2-positivo", mech: "Ac monoclonales dirigidos a HER2" },
            { cat: "CÁNCER", drug: "PIFLUFOLASTAT", ind: "Detección PET lesiones PSMA", mech: "Inhibidor del PSMA, radionucleido para PET" },
            { cat: "CÁNCER", drug: "PIRTOBRUNITIB", ind: "Linfoma de células del manto", mech: "Inhibidor reversible no covalente de BTK" },
            { cat: "CÁNCER", drug: "PRALSETINIB", ind: "CPNM con fusión RET+", mech: "Inhibidor tirosina quinasa anti RET" },
            { cat: "CÁNCER", drug: "QUIZARTINIB", ind: "LMA", mech: "Inhibidor del receptor tirosina quinasa FLT3" },
            { cat: "CÁNCER", drug: "RELATLIMAB/ NIVOLUMAB", ind: "Melanoma", mech: "Ac contra PD-1 y LAG-3" },
            { cat: "CÁNCER", drug: "RELUGOLIX", ind: "Cáncer de próstata", mech: "Antagonista del receptor GnRH" },
            { cat: "CÁNCER", drug: "REPOTRECTINIB", ind: "CPNM", mech: "Inhibidor ROS1, TRK y ALK" },
            { cat: "CÁNCER", drug: "RIBOCICLIB", ind: "Cáncer de mama RH+ HER2-", mech: "Inhibidor selectivo CDK4 y CDK6" },
            { cat: "CÁNCER", drug: "RIPRETINIB", ind: "GIST avanzado", mech: "Inhibidor tirosina quinasa KIT y PDGFRA" },
            { cat: "CÁNCER", drug: "RUCAPARIB", ind: "Cáncer ovario", mech: "Inhibidor de PARP-1, 2 y 3" },
            { cat: "CÁNCER", drug: "SACITUZUMAB GOVITECÁN", ind: "Cáncer de mama triple negativo", mech: "Anti Trop-2, libera SN-38 (inhibidor topoisomerasa I)" },
            { cat: "CÁNCER", drug: "SELINEXOR", ind: "Mieloma múltiple", mech: "Inhibidor de la exportación nuclear (SINE) bloquea XPO1" },
            { cat: "CÁNCER", drug: "SELPERCATINIB", ind: "CPNM y tiroides fusión RET+", mech: "Inhibidor del receptor tirosina quinasa RET" },
            { cat: "CÁNCER", drug: "SONIDEGIB", ind: "Carcinoma basocelular", mech: "Inhibe vía Hedgehog" },
            { cat: "CÁNCER", drug: "SORAFENIB ACCORD", ind: "Carcinoma hepatocelular y renal", mech: "Inhibidor multiquinasa" },
            { cat: "CÁNCER", drug: "SOTORASIB", ind: "CPNM mutación KRAS G12C", mech: "Inhibidor selectivo KRAS G12C" },
            { cat: "CÁNCER", drug: "TALAZOPARIB", ind: "Cáncer mama HER2- (BRCA mutado)", mech: "Inhibidor de enzimas PARP" },
            { cat: "CÁNCER", drug: "TALIMOGENE LAHERPAREPVEC", ind: "Melanoma irresecable", mech: "Virus oncolítico (VHS-1 modificado) produce GM-CSF" },
            { cat: "CÁNCER", drug: "TALQUETAMAB", ind: "Mieloma múltiple", mech: "Ac biespecífico anti GPRC5D y CD3" },
            { cat: "CÁNCER", drug: "TEBENTAFUSP", ind: "Melanoma uveal irresecable", mech: "Receptor de linfocitos T fusionado a anti-CD3" },
            { cat: "CÁNCER", drug: "TECARTUS", ind: "Linfoma células manto", mech: "CAR-T anti CD19" },
            { cat: "CÁNCER", drug: "TECLISTAMAB", ind: "Mieloma múltiple", mech: "Ac anti BCMA y CD3" },
            { cat: "CÁNCER", drug: "TEGAFUR/ GIMERACIL/ OTERACILO", ind: "Cáncer colorrectal y gástrico", mech: "Tegafur -> Fluorouracilo (citotóxico). Otros inhiben degradación." },
            { cat: "CÁNCER", drug: "TEPOTINIB", ind: "CPNM", mech: "Inhibidor reversible tipo I de MET" },
            { cat: "CÁNCER", drug: "TISAGENCLEUCEL", ind: "LLA células B, Linfoma difuso B", mech: "CAR-T anti CD19" },
            { cat: "CÁNCER", drug: "TISLELIZUMAB", ind: "Carcinoma escamoso esófago", mech: "Ac monoclonal IgG4 anti PD-1" },
            { cat: "CÁNCER", drug: "TIVOZANIB", ind: "Carcinoma renal avanzado", mech: "Bloqueo de receptores VEGF" },
            { cat: "CÁNCER", drug: "TORIPALIMAB", ind: "Cáncer de nasofaringe", mech: "Ac monoclonal IgG4 anti PD-1" },
            { cat: "CÁNCER", drug: "TRASTUZUMAB DERUXTECÁN", ind: "Cáncer mama HER2+, gástrico", mech: "Anti HER2 unido a inhibidor topoisomerasa I" },
            { cat: "CÁNCER", drug: "TREMELIMUMAB", ind: "Carcinoma hepatocelular, CPNM", mech: "Bloquea interacción CTLA-4 con CD80/CD86" },
            { cat: "CÁNCER", drug: "TRIFLURIDINA/ TIPIRACILO", ind: "Cáncer colorrectal metastásico", mech: "Interfiere con ADN. Tipiracilo inhibe degradación" },
            { cat: "CÁNCER", drug: "TUCATINIB", ind: "Cáncer de mama HER2+", mech: "Inhibidor tirosina quinasa selectivo HER2" },
            { cat: "CÁNCER", drug: "VENETOCLAX", ind: "LLC", mech: "Inhibe BCL-2" },
            { cat: "CARDIOVASCULAR", drug: "ALIROCUMAB", ind: "Hipercolesterolemia", mech: "Ac anti PCSK9" },
            { cat: "CARDIOVASCULAR", drug: "ANDEXANET ALFA", ind: "Reversión anticoagulación inhibidores Xa", mech: "Análogo factor Xa que atrapa el inhibidor" },
            { cat: "CARDIOVASCULAR", drug: "APROCITENTÁN", ind: "Hipertensión", mech: "Inhibe fijación ET-1 a receptores ETA y ETB" },
            { cat: "CARDIOVASCULAR", drug: "DAPAGLIFLOZINA", ind: "DM2, insuficiencia cardiaca, IRC", mech: "Inhibidor SGLT2" },
            { cat: "CARDIOVASCULAR", drug: "EVINACUMAB", ind: "Hipercolesterolemia familiar homocigótica", mech: "Ac anti ANGPTL3" },
            { cat: "CARDIOVASCULAR", drug: "EVOLOCUMAB", ind: "Hipercolesterolemia", mech: "Ac anti PCSK9" },
            { cat: "CARDIOVASCULAR", drug: "FINERENONA", ind: "ERC asociada a diabetes tipo 2", mech: "Antagonista selectivo receptor mineralocorticoides" },
            { cat: "CARDIOVASCULAR", drug: "MAVACAMTEM", ind: "Miocardiopatía hipertrófica obstructiva", mech: "Inhibidor selectivo miosina cardiaca" },
            { cat: "CARDIOVASCULAR", drug: "SELEXIPAG", ind: "Hipertensión arterial pulmonar", mech: "Agonista selectivo receptores prostaciclina" },
            { cat: "CARDIOVASCULAR", drug: "VERICIGUAT", ind: "Insuficiencia cardiaca crónica", mech: "Estimulador de guanilato ciclasa soluble" },
            { cat: "DERMATOLOGÍA", drug: "ABROCITINIB", ind: "Dermatitis atópica", mech: "Inhibidor de JAK" },
            { cat: "DERMATOLOGÍA", drug: "BIMEKIZUMAB", ind: "Psoriasis", mech: "Inhibe IL-17A, IL-17F" },
            { cat: "DERMATOLOGÍA", drug: "DUPILUMAB", ind: "Dermatitis atópica/Asma", mech: "Inhibe señalización IL-4 e IL-13" },
            { cat: "DERMATOLOGÍA", drug: "GUSELKUMAB", ind: "Psoriasis", mech: "Anti IL-23" },
            { cat: "DERMATOLOGÍA", drug: "IXEKIZUMAB", ind: "Psoriasis", mech: "Anti IL-17A" },
            { cat: "DERMATOLOGÍA", drug: "RISANKIZUMAB", ind: "Psoriasis", mech: "Anti IL-23 (subunidad p19)" },
            { cat: "DERMATOLOGÍA", drug: "TRALOKINUMAB", ind: "Dermatitis atópica", mech: "Anti IL-13" },
            { cat: "DIGESTIVO", drug: "ÁCIDO OBETICÓLICO", ind: "Colangitis biliar primaria", mech: "Activa receptor X farnesoide (FXR)" },
            { cat: "DIGESTIVO", drug: "ETRASIMOV", ind: "Colitis ulcerosa", mech: "Modulador receptores esfingosina 1-fosfato (S1P)" },
            { cat: "ENDOCRINOLOGÍA", drug: "SEMAGLUTIDA", ind: "Control de peso / DM2", mech: "Agonista receptor GLP-1" },
            { cat: "ENDOCRINOLOGÍA", drug: "TIRZEPATIDA", ind: "DM2", mech: "Agonista dual GIP y GLP-1" },
            { cat: "HEMATOLOGÍA", drug: "ACALABRUTINIB", ind: "LLC", mech: "Inhibidor BTK" },
            { cat: "HEMATOLOGÍA", drug: "EMICIZUMAB", ind: "Hemofilia A", mech: "Une factor IX activado y factor X" },
            { cat: "INFECCIONES", drug: "CABOTEGRAVIR", ind: "VIH-1", mech: "Inhibición integrasa VIH" },
            { cat: "INFECCIONES", drug: "REMDESIVIR", ind: "COVID-19", mech: "Inhibidor polimerasa ARN viral" },
            { cat: "INFECCIONES", drug: "PAXLOVID (Ritonavir/Nirmatrelvir)", ind: "COVID-19", mech: "Inhibidor proteasa SARS-CoV-2" },
            { cat: "INMUNOLOGÍA", drug: "BARICITINIB", ind: "Artritis, dermatitis, alopecia", mech: "Inhibidor JAK1 y JAK2" },
            { cat: "INMUNOLOGÍA", drug: "UPADACITINIB", ind: "Artritis reumatoide", mech: "Inhibición JAK1 y JAK3" },
            { cat: "NEUROLOGÍA", drug: "ERENUMAB", ind: "Migraña", mech: "Bloquea receptor CGRP" },
            { cat: "NEUROLOGÍA", drug: "GALCANEZUMAB", ind: "Migraña", mech: "Une CGRP impidiendo interacción receptor" },
            { cat: "NEUROLOGÍA", drug: "NUSINERSEN", ind: "Atrofia muscular espinal", mech: "Oligonucleótido antisentido (gen SMN2)" },
            { cat: "NEUROLOGÍA", drug: "OCRELIZUMAB", ind: "Esclerosis múltiple", mech: "Anti CD20" },
            { cat: "NEUROLOGÍA", drug: "RIMEGEPANT", ind: "Migraña", mech: "Antagonista receptor CGRP" },
            { cat: "VACUNAS", drug: "GARDASIL 9", ind: "VPH", mech: "Vacuna nonavalente recombinante" },
            { cat: "VACUNAS", drug: "SHINGRIX", ind: "Herpes zóster", mech: "Vacuna recombinante adyuvada" },
            { cat: "VACUNAS", drug: "QDENGA", ind: "Dengue", mech: "Virus atenuados tetravalente" },
            { cat: "OTROS", drug: "FEZOLINETANT", ind: "Menopausia (síntomas vasomotores)", mech: "Antagonista receptor neuroquinina 3 (NK3)" }
        ];

        // --- PARSER DE CSV SIMPLE ---
        function parseCSV(csvText, categoryName, drugColIndex = 0) {
            const lines = csvText.trim().split('\n');
            const headers = parseLine(lines[0]);
            const data = [];
            
            // Si el nombre del fármaco no está en la primera columna (0),
            // lo indicamos para que lo coja de la columna correcta.
            // Para Antiparasitarios es 1.
            
            let lastGroupValue = "";

            for (let i = 1; i < lines.length; i++) {
                const currentLine = parseLine(lines[i]);
                if (currentLine.length < 2) continue;

                let drugName = currentLine[drugColIndex];
                
                // Lógica especial para filas agrupadas (ej: Antiparasitarios)
                // Si la columna 0 (Grupo) está vacía, usamos la anterior.
                // Si drugColIndex > 0 (ej: Antiparasitarios), la columna 0 suele ser el grupo/parasitosis.
                if (drugColIndex > 0) {
                    const groupVal = currentLine[0];
                    if (groupVal && groupVal.trim() !== "") {
                        lastGroupValue = groupVal;
                    }
                }

                // Limpieza de nombre
                drugName = drugName || "Desconocido";
                drugName = drugName.replace(/^"|"$/g, '').trim();

                let item = {
                    cat: categoryName,
                    drug: drugName,
                    details: {}
                };
                
                // Si hay grupo heredado, lo añadimos como detalle principal
                if (lastGroupValue && drugColIndex > 0) {
                    item.details[headers[0]] = lastGroupValue; // Ej: "Parasitosis": "Amebas"
                }

                // Mapear el resto de columnas a detalles
                headers.forEach((header, index) => {
                    // Saltamos la columna del nombre del fármaco
                    if (index === drugColIndex) return; 
                    
                    // Saltamos la columna grupo si ya la hemos procesado arriba
                    if (index === 0 && drugColIndex > 0) return;

                    let val = currentLine[index];
                    if (val && val.trim() !== "") {
                        // Limpiar comillas extra
                        val = val.replace(/^"|"$/g, '').trim();
                        // Reemplazar guiones de lista por saltos de línea HTML
                        val = val.replace(/- /g, '<br>• ');
                        item.details[header] = val;
                    }
                });

                data.push(item);
            }
            return data;
        }

        // Función auxiliar para manejar comillas en CSV (RFC 4180 básico)
        function parseLine(text) {
            const result = [];
            let cell = '';
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') { inQuotes = !inQuotes; }
                else if (char === ',' && !inQuotes) {
                    result.push(cell.trim());
                    cell = '';
                } else {
                    cell += char;
                }
            }
            result.push(cell.trim());
            return result;
        }

        // --- CONSTRUCCIÓN DE LA BASE DE DATOS ---
        const DB = {
            anticuerpos: OLD_DATA_RAW,
            antiinfecciosos: {
                antibacterianos: parseCSV(CSV_ANTIBACTERIANOS, "Antibacterianos"),
                antifungicos: parseCSV(CSV_ANTIFUNGICOS, "Antifúngicos"),
                // Antiparasitarios tiene el fármaco en la columna 1
                antiparasitarios: parseCSV(CSV_ANTIPARASITARIOS, "Antiparasitarios", 1),
                antisepticos: parseCSV(CSV_ANTISEPTICOS, "Antisépticos"),
                antituberculosos: parseCSV(CSV_ANTITUBERCULOSOS, "TBC y Lepra"),
                antivirales: parseCSV(CSV_ANTIVIRALES, "Antivirales")
            }
        };

        // --- VARIABLES DE ESTADO ---
        let currentDeck = [];
        let currentLevelDeck = [];
        let currentCard = null;
        let score = 0;
        let errors = 0;
        let currentLevel = 0;
        let gameMode = 'marathon';
        let hintEnabled = false;
        let isCardFlipped = false;
        
        let reviewList = JSON.parse(localStorage.getItem('ramonaReviews') || '[]');
        let customBirdImage = localStorage.getItem('ramonaCustomImage');
        const CARDS_PER_LEVEL = 10;

        // --- INICIALIZACIÓN ---
        lucide.createIcons();
        if(customBirdImage) updateBirdIcons();
        const savedTheme = localStorage.getItem('ramonaTheme') || 'default';
        setTheme(savedTheme);

        // --- NAVEGACIÓN ---
        function selectDeckCategory(category) {
            document.getElementById('welcome-screen').classList.add('hidden');
            
            if (category === 'anticuerpos') {
                // Carga directa para anticuerpos
                currentDeck = [...DB.anticuerpos];
                showModeScreen("Anticuerpos");
            } else {
                // Mostrar submenú para antiinfecciosos
                showSubgroupMenu();
            }
        }

        function showSubgroupMenu() {
            const list = document.getElementById('subgroup-list');
            list.innerHTML = '';
            
            // Botón Mezclar Todo
            list.innerHTML += `
                <button onclick="selectSubgroup('all')" class="w-full bg-purple-100 hover:bg-purple-200 p-4 rounded-xl font-bold text-purple-800 flex justify-between items-center transition">
                    <span>Mezclar Todo (Mix)</span>
                    <i data-lucide="shuffle" class="w-5 h-5"></i>
                </button>
            `;

            // Botones por grupo
            const groups = [
                { id: 'antibacterianos', label: 'Antibacterianos', color: 'bg-red-50 text-red-800 border-red-100' },
                { id: 'antivirales', label: 'Antivirales', color: 'bg-blue-50 text-blue-800 border-blue-100' },
                { id: 'antifungicos', label: 'Antifúngicos', color: 'bg-yellow-50 text-yellow-800 border-yellow-100' },
                { id: 'antiparasitarios', label: 'Antiparasitarios', color: 'bg-green-50 text-green-800 border-green-100' },
                { id: 'antituberculosos', label: 'TBC y Lepra', color: 'bg-orange-50 text-orange-800 border-orange-100' },
                { id: 'antisepticos', label: 'Antisépticos', color: 'bg-gray-50 text-gray-800 border-gray-100' }
            ];

            groups.forEach(g => {
                list.innerHTML += `
                    <button onclick="selectSubgroup('${g.id}')" class="w-full ${g.color} hover:brightness-95 border p-3 rounded-xl font-bold flex justify-between items-center transition text-sm">
                        <span>${g.label}</span>
                        <i data-lucide="chevron-right" class="w-4 h-4 opacity-50"></i>
                    </button>
                `;
            });
            
            lucide.createIcons();
            document.getElementById('subgroup-screen').classList.remove('hidden');
        }

        function selectSubgroup(subId) {
            if (subId === 'all') {
                currentDeck = [];
                Object.values(DB.antiinfecciosos).forEach(arr => currentDeck.push(...arr));
            } else {
                currentDeck = [...DB.antiinfecciosos[subId]];
            }
            showModeScreen(subId === 'all' ? "Antiinfecciosos (Mix)" : subId.toUpperCase());
        }

        function showModeScreen(title) {
            document.getElementById('subgroup-screen').classList.add('hidden');
            document.getElementById('mode-screen').classList.remove('hidden');
            document.getElementById('mode-title').innerText = title;
        }

        function goBackToWelcome() {
            document.getElementById('subgroup-screen').classList.add('hidden');
            document.getElementById('welcome-screen').classList.remove('hidden');
        }

        function goBackToSubgroupOrWelcome() {
            document.getElementById('mode-screen').classList.add('hidden');
            document.getElementById('welcome-screen').classList.remove('hidden');
        }

        function goToMenu() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.add('hidden');
            document.getElementById('level-complete-screen').classList.add('hidden');
            document.getElementById('welcome-screen').classList.remove('hidden');
            score = 0; errors = 0;
        }

        // --- LÓGICA DE JUEGO ---
        function startMode(mode) {
            gameMode = mode;
            score = 0; errors = 0; currentLevel = 0;
            hintEnabled = false; updateHintUI();
            
            // Barajar mazo seleccionado
            shuffle(currentDeck);

            document.getElementById('mode-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('flex');

            if (gameMode === 'marathon') {
                currentLevelDeck = [...currentDeck];
                updateLevelUI("Maratón", "Sin límites");
            } else {
                startLevel(0);
                return;
            }
            
            updateUI();
            loadNextCard();
        }

        function startLevel(lvlIndex) {
            const start = lvlIndex * CARDS_PER_LEVEL;
            const end = start + CARDS_PER_LEVEL;
            
            if (start >= currentDeck.length) {
                showWinScreen();
                return;
            }
            
            currentLevel = lvlIndex;
            currentLevelDeck = currentDeck.slice(start, end);
            updateLevelUI(`Nivel ${lvlIndex + 1}`, `Fase ${lvlIndex + 1}`);
            
            document.getElementById('level-complete-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('flex');
            
            updateUI();
            loadNextCard();
        }

        function loadNextCard() {
            if (currentLevelDeck.length === 0) {
                handleEmptyDeck();
                return;
            }

            isCardFlipped = false;
            document.getElementById('flashcard').classList.remove('flipped');
            document.getElementById('controls').style.opacity = '0';
            document.getElementById('controls').style.pointerEvents = 'none';

            currentCard = currentLevelDeck.shift();

            // Renderizar Front
            setTimeout(() => {
                document.getElementById('card-category').innerText = currentCard.cat;
                document.getElementById('card-drug').innerText = currentCard.drug;
                
                // Renderizar Back (Dinámico)
                renderCardBack(currentCard);
                
                // Pista color categoría
                updateHintUI();
                updateStarIcon();
            }, 200);
            
            updateUI();
        }

        function renderCardBack(card) {
            const container = document.getElementById('card-details-content');
            const title = document.getElementById('back-card-title');
            container.innerHTML = '';
            title.innerText = card.drug;

            // Si es mazo antiguo (estructura simple)
            if (card.ind && card.mech) {
                container.innerHTML = `
                    <div class="bg-orange-50 p-3 rounded-lg border border-orange-100">
                        <h4 class="text-xs font-bold text-orange-600 uppercase mb-1">Indicación</h4>
                        <p class="text-sm text-gray-700">${card.ind}</p>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg border border-purple-100">
                        <h4 class="text-xs font-bold text-purple-600 uppercase mb-1">Mecanismo</h4>
                        <p class="text-sm text-gray-700">${card.mech}</p>
                    </div>
                `;
            } 
            // Si es mazo nuevo (estructura compleja en 'details')
            else if (card.details) {
                for (const [key, value] of Object.entries(card.details)) {
                    const colors = ['blue', 'green', 'purple', 'orange', 'teal', 'pink'];
                    const color = colors[key.length % colors.length];
                    
                    container.innerHTML += `
                        <details class="group/acc bg-white border border-gray-200 rounded-lg overflow-hidden" open>
                            <summary class="px-4 py-2 bg-gray-50 text-xs font-bold text-gray-500 uppercase flex justify-between items-center select-none">
                                ${key}
                                <i data-lucide="chevron-down" class="w-3 h-3 transition-transform group-open/acc:rotate-180"></i>
                            </summary>
                            <div class="px-4 py-2 text-sm text-gray-700 border-t border-gray-100 bg-${color}-50 bg-opacity-30 leading-relaxed">
                                ${value}
                            </div>
                        </details>
                    `;
                }
                lucide.createIcons();
            }
        }

        // --- UTILIDADES ---
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function updateUI() {
            document.getElementById('score-display').innerText = score;
            let progress = 0;
            if (gameMode === 'story') {
                progress = 100 - ((currentLevelDeck.length / CARDS_PER_LEVEL) * 100);
            } else {
                // Maratón: Estimación
                const total = currentDeck.length + currentLevelDeck.length + errors; 
                progress = 100 - ((currentLevelDeck.length / (total || 1)) * 100);
            }
            if(progress < 0) progress = 0; if(progress > 100) progress = 100;
            
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('bird-icon-bar').style.left = `${progress}%`;
        }

        function handleAnswer(isCorrect) {
            if (isCorrect) {
                score += 10;
            } else {
                errors++;
                if (currentLevelDeck.length > 3) {
                    const pos = Math.floor(Math.random() * (currentLevelDeck.length - 1)) + 1;
                    currentLevelDeck.splice(pos, 0, currentCard);
                } else {
                    currentLevelDeck.push(currentCard);
                }
            }
            loadNextCard();
        }

        function flipCard() {
            isCardFlipped = true;
            document.getElementById('flashcard').classList.add('flipped');
            setTimeout(() => {
                document.getElementById('controls').style.opacity = '1';
                document.getElementById('controls').style.pointerEvents = 'auto';
            }, 300);
        }

        function handleEmptyDeck() {
            if (gameMode === 'marathon') {
                showWinScreen();
            } else {
                const nextStart = (currentLevel + 1) * CARDS_PER_LEVEL;
                if (nextStart >= currentDeck.length) showWinScreen();
                else showLevelComplete();
            }
        }

        function showLevelComplete() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('flex');
            document.getElementById('level-complete-screen').classList.remove('hidden');
        }

        function nextLevel() {
            startLevel(currentLevel + 1);
        }

        function showWinScreen() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('flex');
            document.getElementById('end-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            document.getElementById('final-errors').innerText = errors;
        }

        function updateLevelUI(label, title) {
            document.getElementById('level-indicator').innerText = label;
            document.getElementById('level-title').innerText = title;
        }

        // --- PISTAS Y FAVORITOS ---
        function toggleHintConfig() {
            hintEnabled = !hintEnabled;
            updateHintUI();
        }

        function updateHintUI() {
            const btn = document.getElementById('btn-hint');
            const cat = document.getElementById('card-category');
            if(hintEnabled) {
                btn.classList.add('text-yellow-500', 'bg-yellow-50');
                cat.classList.remove('blur-category');
            } else {
                btn.classList.remove('text-yellow-500', 'bg-yellow-50');
                cat.classList.add('blur-category');
            }
        }

        function toggleReview(e) {
            e.stopPropagation();
            const drug = currentCard.drug;
            if (reviewList.includes(drug)) reviewList = reviewList.filter(d => d !== drug);
            else reviewList.push(drug);
            localStorage.setItem('ramonaReviews', JSON.stringify(reviewList));
            updateStarIcon();
        }

        function updateStarIcon() {
            const isMarked = reviewList.includes(currentCard.drug);
            document.querySelectorAll('.star-btn svg').forEach(icon => {
                if (isMarked) icon.classList.add('star-active');
                else icon.classList.remove('star-active');
            });
        }

        // --- IMAGEN Y TEMA ---
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    localStorage.setItem('ramonaCustomImage', ev.target.result);
                    customBirdImage = ev.target.result;
                    updateBirdIcons();
                    toggleThemeModal();
                } catch(err) { alert("Imagen muy grande"); }
            };
            reader.readAsDataURL(file);
        }

        function updateBirdIcons() {
            const createImg = (isSmall) => {
                if(customBirdImage) {
                    return `<img src="${customBirdImage}" class="custom-bird-img ${isSmall ? 'w-8 h-8 -ml-4 absolute top-1/2 -translate-y-1/2' : 'w-24 h-24 bird-anim'}">`;
                }
                return isSmall 
                    ? `<i data-lucide="bird" class="w-6 h-6 text-orange-600 -ml-3 bg-white rounded-full p-0.5 shadow-sm border border-orange-200"></i>`
                    : `<i data-lucide="bird" class="w-24 h-24 text-orange-500 bird-anim"></i>`;
            };
            
            document.getElementById('welcome-bird-container').innerHTML = createImg(false);
            document.getElementById('bird-icon-bar').innerHTML = createImg(true);
            document.getElementById('end-bird-container').innerHTML = createImg(false);
            lucide.createIcons();
        }

        function toggleThemeModal() {
            document.getElementById('theme-modal').classList.toggle('hidden');
        }

        function setTheme(theme) {
            const b = document.getElementById('main-body');
            b.className = "min-h-screen flex flex-col text-slate-800 transition-colors duration-500";
            if (theme === 'sunset') b.classList.add('bg-gradient-to-b', 'from-orange-100', 'to-rose-100');
            else if (theme === 'mint') b.classList.add('bg-gradient-to-b', 'from-teal-100', 'to-emerald-100');
            else b.classList.add('bg-gradient-to-b', 'from-blue-100', 'to-green-100');
            
            localStorage.setItem('ramonaTheme', theme);
            if(!document.getElementById('theme-modal').classList.contains('hidden')) toggleThemeModal();
        }
    </script>
</body>
</html>
